schema: CLC
name: VWCLC_ANLT_EMSR_AGND_EMSR_0811
updatedAllowed: true
insertAllowed: true
viewDefinition: |-
  SELECT
    /*+ ORDERED */
    LNRECB1.DT_RFRN_MVMN AS DT_RFRN_MVMN,
    LNRMNR1.DT_VNCM_LQDC_EMSR,
    NVL(LNRECB1.NU_RFRN, 0) AS NU_RFRN_RLTR,
    LNRECB1.NU_SQNL,
    CRTO1.NU_BIN_RECB AS NU_BIN_RLTR,
    LNRECB1.CD_BNDR AS CD_BNDR,
    LNRECB1.CD_CRDE AS CD_CRDE,
    LNRECB1.CD_TIPO_PLTF_PGMN,
    decode(LNRECB1.CD_EMSR, 204, 237, LNRECB1.CD_EMSR) AS CD_EMSR_RLTR,
    LNRECB1.CD_PCSR AS CD_PCSR_RLTR,
    LNRECB1.CD_TIPO_TRNS_BNDR_RECB AS CD_TIPO_TRNS_BNDR_RLTR,
    CAST(LNRECB1.CD_TIPO_TRNS_BNDR_RECB AS NUMBER(2)) AS CD_TIPO_TRNS_ORIG,
    LNRECB1.CD_PRDT_BNDR_RECB AS CD_PRDT_BNDR_RLTR,
    LNRECB1.CD_ERRO_PCSM_LQDC_RECB AS CD_ERRO_PCSM_LQDC,
    LNRECB1.TX_VALR_ORGM_TRNE_FNDO AS TX_VALR_ORGM_TRNE_FNDO_RLTR,
    LNRECB1.CD_TIPO_APRS_TRNS_RECB AS CD_TIPO_APRS_TRNS_RLTR,
    LNRECB1.CD_MODA_RECB AS CD_MODA_RLTR,
    LNRECB1.CD_RGRA_OPRC_TRNS AS CD_RGRA_OPRC_TRNS,
    TTOP1.CD_TIPO_OPRD,
    CAST(LNRECB1.TX_VALR_TRNS AS VARCHAR(17)) AS TX_VALR_TRNS_RLTR,
    CAST(LNRECB1.TX_VALR_VNDA AS VARCHAR(17)) AS TX_VALR_VNDA,
    CAST(LNRECB1.TX_VALR_TAXA_EMBQ AS VARCHAR(17)) AS TX_VALR_TAXA_EMBQ_RLTR,
    CAST(LNRMNR1.VL_ITCM_VNDA AS NUMBER(17, 2)) AS VL_ITCM_VNDA
  FROM
    CLC.TBCLCR_LNCM_RECB LNRECB1,
    CLC.TBCLCR_CRTO_CRPT_LNCM_RECB CRTO1,
    CLC.TBCLCR_LNCM_RECB_RMNR LNRMNR1,
    CLC.TBCLCR_TIPO_TRNS_OPRD TTOP1
  WHERE
    TTOP1.CD_BNDR = LNRECB1.CD_BNDR + 0
    AND TTOP1.CD_TIPO_TRNS_BNDR = LNRECB1.CD_TIPO_TRNS_BNDR_RECB || ''
    AND TTOP1.CD_TIPO_TRNS_BNDR_ORGM = LNRECB1.CD_TIPO_TRNS_BNDR_RECB
    AND TTOP1.SG_ORGM_IFMC = LNRECB1.SG_ORGM_IFMC_RECB || ''
    AND CRTO1.CD_BNDR = LNRECB1.CD_BNDR + 0
    AND CRTO1.DT_RFRN_MVMN = LNRECB1.DT_RFRN_MVMN + 0
    AND CRTO1.CD_TIPO_PLTF_PGMN = LNRECB1.CD_TIPO_PLTF_PGMN
    AND CRTO1.CD_CRDE = LNRECB1.CD_CRDE
    AND CRTO1.NU_RMSA_CRDE = LNRECB1.NU_RMSA_CRDE + 0
    AND CRTO1.CD_EMSR = LNRECB1.CD_EMSR
    AND CRTO1.CD_PCSR = LNRECB1.CD_PCSR
    AND CRTO1.NU_RMSA_EMSR = LNRECB1.NU_RMSA_EMSR + 0
    AND CRTO1.NU_SQNL = LNRECB1.NU_SQNL
    AND CRTO1.CD_TIPO_CNCT_CRTO + 0 = 1
    AND LNRMNR1.DT_RFRN_MVMN (+) = LNRECB1.DT_RFRN_MVMN
    AND LNRMNR1.CD_BNDR (+) = LNRECB1.CD_BNDR
    AND LNRMNR1.CD_TIPO_PLTF_PGMN (+) = LNRECB1.CD_TIPO_PLTF_PGMN
    AND LNRMNR1.CD_CRDE (+) = LNRECB1.CD_CRDE
    AND LNRMNR1.CD_EMSR (+) = LNRECB1.CD_EMSR
    AND LNRMNR1.CD_PCSR (+) = LNRECB1.CD_PCSR
    AND LNRMNR1.NU_RMSA_CRDE (+) = LNRECB1.NU_RMSA_CRDE
    AND LNRMNR1.NU_RMSA_EMSR (+) = LNRECB1.NU_RMSA_EMSR
    AND LNRMNR1.NU_SQNL (+) = LNRECB1.NU_SQNL
    AND LNRMNR1.CD_TIPO_TRNS_BNDR_RECB (+) = LNRECB1.CD_TIPO_TRNS_BNDR_RECB
    AND nvl(lnrmnr1.nu_rfrn, 0) = nvl(lnrecb1.nu_rfrn, 0) -- AND LNRMNR1.nu_rfrn (+) = LNRECB1.nu_rfrn
    AND LNRECB1.SG_ORGM_IFMC_RECB = 'EMI' --alterar depois volta data de ciclo
    AND LNRMNR1.DT_RFRN_MVMN = (
      SELECT
        DT_PCSM_ATUL
      FROM
        CCR.TBCCRR_CICL_PCSM_CDST TBCCRR_CICL_PCSM_CDST1
    )
    AND LNRECB1.DT_RFRN_MVMN = (
      SELECT
        DT_PCSM_ATUL
      FROM
        CCR.TBCCRR_CICL_PCSM_CDST TBCCRR_CICL_PCSM_CDST2
    )
    AND CD_ERRO_PCSM_LQDC_RECB IS NULL
  UNION ALL
  SELECT
    LNRECB2.DT_RERO_EMSR AS DT_RFRN_MVMN,
    LNRMNR2.DT_VNCM_LQDC_EMSR,
    LNRECB2.NU_RFRN AS NU_RFRN_RLTR,
    LNRECB2.NU_SQNL,
    CRTO2.NU_BIN_RECB AS NU_BIN_RLTR,
    LNRECB2.CD_BNDR AS CD_BNDR,
    LNRECB2.CD_CRDE AS CD_CRDE,
    LNRECB2.CD_TIPO_PLTF_PGMN,
    decode (LNRECB2.CD_EMSR, 204, 237, LNRECB2.CD_EMSR) AS CD_EMSR_RLTR,
    LNRECB2.CD_PCSR AS CD_PCSR_RLTR,
    '01' AS CD_TIPO_TRNS_BNDR_RLTR,
    CAST(LNRECB2.CD_TIPO_TRNS_BNDR_RECB AS NUMBER(2)) AS CD_TIPO_TRNS_ORIG,
    LNRECB2.CD_PRDT_BNDR_RECB AS CD_PRDT_BNDR_RLTR,
    LNRECB2.CD_ERRO_PCSM_LQDC_RECB AS CD_ERRO_PCSM_LQDC,
    LNRECB2.TX_VALR_ORGM_TRNE_FNDO AS TX_VALR_ORGM_TRNE_FNDO_RLTR,
    LNRECB2.CD_TIPO_APRS_TRNS_RECB AS CD_TIPO_APRS_TRNS_RLTR,
    LNRECB2.CD_MODA_RECB AS CD_MODA_RLTR,
    LNRECB2.CD_RGRA_OPRC_TRNS AS CD_RGRA_OPRC_TRNS,
    TTOP2.CD_TIPO_OPRD,
    CAST(LNRECB2.TX_VALR_TRNS AS VARCHAR(17)) AS TX_VALR_TRNS_RLTR,
    CAST(LNRECB2.TX_VALR_VNDA AS VARCHAR(17)) AS TX_VALR_VNDA,
    CAST(LNRECB2.TX_VALR_TAXA_EMBQ AS VARCHAR(17)) AS TX_VALR_TAXA_EMBQ_RLTR,
    CAST(LNRMNR2.VL_ITCM_VNDA AS NUMBER(17, 2)) AS VL_ITCM_VNDA
  FROM
    (
      SELECT
        LNRECB3.DT_RFRN_MVMN,
        LNRECB3.DT_RERO_EMSR,
        LNRECB3.CD_BNDR,
        LNRECB3.CD_CRDE,
        LNRECB3.CD_TIPO_PLTF_PGMN,
        decode (LNRECB3.CD_EMSR, 204, 237, LNRECB3.CD_EMSR) CD_EMSR,
        LNRECB3.CD_PCSR,
        LNRECB3.CD_PRDT_BNDR_RECB,
        LNRECB3.CD_MODA_RECB,
        LNRECB3.CD_TIPO_TRNS_BNDR_RECB,
        LNRECB3.QT_DIA_LQDC_ENVO_EMSR,
        LNRECB3.NU_RFRN,
        LNRECB3.CD_ATZC_TRNS,
        LNRECB3.CD_PDV_RECB,
        LNRECB3.NU_CLNT,
        LNRECB3.SG_ORGM_IFMC_RECB,
        LNRECB3.CD_ERRO_PCSM_LQDC_RECB,
        LNRECB3.CD_MCC_BNDR_RECB,
        LNRECB3.TX_DATA_VNDA,
        LNRECB3.SG_TPPS_RECB,
        LNRECB3.IN_RNVO_TRNS,
        LNRECB3.TX_QNTD_TOTL_PRCL,
        LNRECB3.NU_PRCL,
        LNRECB3.TX_VALR_ORGM_TRNE_FNDO,
        LNRECB3.CD_USRO_INCL_RGST,
        LNRECB3.DH_INCL_RGST,
        LNRECB3.TX_QNTD_DIA_LQDC_CRDE_BNDR,
        LNRECB3.QT_DIA_LQDC_BNDR_EMSR,
        LNRECB3.TX_NMRO_CPF_CLNT,
        LNRECB3.TX_NMRO_DV_CPF_CLNT,
        LNRECB3.TX_NMRO_RAIZ_CNPJ_CLNT,
        LNRECB3.TX_NMRO_FILI_CNPJ_CLNT,
        LNRECB3.TX_NMRO_DV_CNPJ_CLNT,
        LNRECB3.CD_TIPO_APRS_TRNS_RECB,
        LNRECB3.TX_VALR_TRNS,
        LNRECB3.CD_TIPO_MVMC_PARC,
        LNRECB3.NU_RMSA_CRDE,
        LNRECB3.NU_RMSA_EMSR,
        LNRECB3.IN_ENVO_ANLT_CRDE_BNDR_EMSR,
        LNRECB3.CD_RGRA_OPRC_TRNS,
        MAX(LNRECB3.NU_SQNL) AS NU_SQNL,
        SUM(LNRECB3.TX_VALR_VNDA) AS TX_VALR_VNDA,
        SUM(LNRECB3.TX_VALR_TAXA_EMBQ) AS TX_VALR_TAXA_EMBQ
      FROM
        CLC.TBCLCR_LNCM_RECB LNRECB3
      WHERE
        LNRECB3.CD_ERRO_PCSM_LQDC_RECB IS NOT NULL
        AND LNRECB3.DT_RERO_EMSR = (
          SELECT
            DT_PCSM_ATUL
          FROM
            CCR.TBCCRR_CICL_PCSM_CDST TBCCRR_CICL_PCSM_CDST3
        )
      GROUP BY
        LNRECB3.DT_RFRN_MVMN,
        LNRECB3.DT_RERO_EMSR,
        LNRECB3.CD_BNDR,
        LNRECB3.CD_CRDE,
        LNRECB3.CD_TIPO_PLTF_PGMN,
        LNRECB3.CD_EMSR,
        LNRECB3.CD_PCSR,
        LNRECB3.CD_PRDT_BNDR_RECB,
        LNRECB3.CD_MODA_RECB,
        LNRECB3.CD_TIPO_TRNS_BNDR_RECB,
        LNRECB3.QT_DIA_LQDC_ENVO_EMSR,
        LNRECB3.NU_RFRN,
        LNRECB3.CD_ATZC_TRNS,
        LNRECB3.CD_PDV_RECB,
        LNRECB3.NU_CLNT,
        LNRECB3.SG_ORGM_IFMC_RECB,
        LNRECB3.CD_ERRO_PCSM_LQDC_RECB,
        LNRECB3.CD_MCC_BNDR_RECB,
        LNRECB3.TX_DATA_VNDA,
        LNRECB3.SG_TPPS_RECB,
        LNRECB3.IN_RNVO_TRNS,
        LNRECB3 .TX_QNTD_TOTL_PRCL,
        LNRECB3.NU_PRCL,
        LNRECB3.TX_VALR_ORGM_TRNE_FNDO,
        LNRECB3.CD_USRO_INCL_RGST,
        LNRECB3.DH_INCL_RGST,
        LNRECB3.TX_QNTD_DIA_LQDC_CRDE_BNDR,
        LNRECB3.QT_DIA_LQDC_BNDR_EMSR,
        LNRECB3.TX_NMRO_CPF_CLNT,
        LNRECB3.TX_NMRO_DV_CPF_CLNT,
        LNRECB3.TX_NMRO_RAIZ_CNPJ_CLNT,
        LNRECB3.TX_NMRO_FILI_CNPJ_CLNT,
        LNRECB3.TX_NMRO_DV_CNPJ_CLNT,
        LNRECB3.CD_TIPO_APRS_TRNS_RECB,
        LNRECB3.TX_VALR_TRNS,
        LNRECB3.CD_TIPO_MVMC_PARC,
        LNRECB3.NU_RMSA_CRDE,
        LNRECB3.NU_RMSA_EMSR,
        LNRECB3.IN_ENVO_ANLT_CRDE_BNDR_EMSR,
        LNRECB3.CD_RGRA_OPRC_TRNS
    ) LNRECB2,
    (
      SELECT
        LNRMNR3.CD_BNDR,
        LNRMNR3.CD_CRDE,
        decode(LNRMNR3.CD_EMSR, 204, 237, LNRMNR3.CD_EMSR) CD_EMSR,
        LNRMNR3.CD_TIPO_PLTF_PGMN,
        LNRMNR3.DT_RFRN_MVMN,
        LNRMNR3.NU_RMSA_CRDE,
        LNRMNR3.CD_PCSR,
        LNRMNR3.NU_RMSA_EMSR,
        LNRMNR3.NU_RFRN,
        LNRMNR3.CD_TIPO_TRNS_BNDR_RECB,
        LNRMNR3.CD_GRPO_RMNR,
        LNRMNR3.CD_TIPO_RMNR,
        LNRMNR3.CD_TIPO_TRNS_ORIG,
        LNRMNR3.DT_VNCM_LQDC_PDV,
        LNRMNR3.DT_VNCM_LQDC_EMSR,
        LNRMNR3.CD_SGMT_ITCM,
        LNRMNR3.CD_TIPO_RMNR_ITCM,
        LNRMNR3.CD_TIPO_TRNS_PGMN,
        LNRMNR3.IN_CNGA_TAXA_PDRO,
        LNRMNR3.VL_TRNS_MXMO,
        LNRMNR3.PC_TAXA_ITCM,
        LNRMNR3.VL_TARF_ITCM_TRNS,
        LNRMNR3.VL_MXMO_ITCM_TRNS,
        LNRMNR3.VL_ITCM_TRNS,
        LNRECB4.NU_PRCL,
        MAX(LNRMNR3.NU_SQNL) AS NU_SQNL,
        SUM(LNRMNR3.VL_TARF_ITCM_VNDA) AS VL_TARF_ITCM_VNDA,
        SUM(LNRMNR3.VL_MXMO_ITCM_VNDA) AS VL_MXMO_ITCM_VNDA,
        SUM(LNRMNR3.VL_ITCM_VNDA) AS VL_ITCM_VNDA
      FROM
        CLC.TBCLCR_LNCM_RECB_RMNR LNRMNR3,
        CLC.TBCLCR_LNCM_RECB LNRECB4
      WHERE
        LNRMNR3.CD_BNDR (+) = LNRECB4.CD_BNDR
        AND LNRMNR3.CD_TIPO_PLTF_PGMN (+) = LNRECB4.CD_TIPO_PLTF_PGMN
        AND LNRMNR3.CD_CRDE (+) = LNRECB4.CD_CRDE
        AND LNRMNR3.CD_EMSR (+) = LNRECB4.CD_EMSR
        AND LNRMNR3.CD_PCSR (+) = LNRECB4.CD_PCSR
        AND LNRMNR3.CD_TIPO_TRNS_BNDR_RECB = '01'
        AND LNRECB4.NU_RFRN = LNRMNR3.NU_RFRN (+)
        AND LNRECB4.NU_RMSA_CRDE = LNRMNR3.NU_RMSA_CRDE (+)
        AND LNRECB4.NU_RMSA_EMSR = LNRMNR3.NU_RMSA_EMSR (+)
        AND LNRECB4.DT_RFRN_MVMN = LNRMNR3.DT_RFRN_MVMN (+)
        AND LNRECB4.NU_SQNL = LNRMNR3.NU_SQNL (+)
        AND LNRECB4.DT_RERO_EMSR = (
          SELECT
            DT_PCSM_ATUL
          FROM
            CCR.TBCCRR_CICL_PCSM_CDST TBCCRR_CICL_PCSM_CDST4
        )
      GROUP BY
        LNRMNR3.CD_BNDR,
        LNRMNR3.CD_CRDE,
        LNRMNR3.CD_EMSR,
        LNRMNR3.CD_TIPO_PLTF_PGMN,
        LNRMNR3.DT_RFRN_MVMN,
        LNRMNR3.NU_RMSA_CRDE,
        LNRMNR3.CD_PCSR,
        LNRMNR3.NU_RMSA_EMSR,
        LNRMNR3.NU_RFRN,
        LNRMNR3.CD_TIPO_TRNS_BNDR_RECB,
        LNRMNR3.CD_GRPO_RMNR,
        LNRMNR3.CD_TIPO_RMNR,
        LNRMNR3.CD_TIPO_TRNS_ORIG,
        LNRMNR3.DT_VNCM_LQDC_PDV,
        LNRMNR3.DT_VNCM_LQDC_EMSR,
        LNRMNR3.CD_SGMT_ITCM,
        LNRMNR3.CD_TIPO_RMNR_ITCM,
        LNRMNR3.CD_TIPO_TRNS_PGMN,
        LNRMNR3.IN_CNGA_TAXA_PDRO,
        LNRMNR3.VL_TRNS_MXMO,
        LNRMNR3.PC_TAXA_ITCM,
        LNRMNR3 .VL_TARF_ITCM_TRNS,
        LNRMNR3.VL_MXMO_ITCM_TRNS,
        LNRMNR3.VL_ITCM_TRNS,
        LNRECB4.NU_PRCL
    ) LNRMNR2,
    CLC.TBCLCR_TIPO_TRNS_OPRD TTOP2,
    CLC.TBCLCR_CRTO_CRPT_LNCM_RECB CRTO2
  WHERE
    LNRECB2.CD_BNDR = TTOP2.CD_BNDR
    AND TTOP2.CD_TIPO_TRNS_BNDR = '01'
    AND LNRECB2.CD_TIPO_TRNS_BNDR_RECB = TTOP2.CD_TIPO_TRNS_BNDR_ORGM
    AND NVL(LNRECB2.CD_TIPO_MVMC_PARC, 0) = NVL(TTOP2.CD_TIPO_MVMC_PARC, 0)
    AND TTOP2.SG_ORGM_IFMC = 'EMI'
    AND LNRECB2.CD_BNDR = CRTO2.CD_BNDR
    AND LNRECB2.DT_RFRN_MVMN = CRTO2.DT_RFRN_MVMN
    AND LNRECB2.CD_TIPO_PLTF_PGMN = CRTO2.CD_TIPO_PLTF_PGMN
    AND LNRECB2.CD_CRDE = CRTO2.CD_CRDE
    AND LNRECB2.NU_RMSA_CRDE = CRTO2.NU_RMSA_CRDE
    AND LNRECB2.CD_EMSR = CRTO2.CD_EMSR
    AND LNRECB2.CD_PCSR = CRTO2.CD_PCSR
    AND LNRECB2.NU_RMSA_EMSR = CRTO2.NU_RMSA_EMSR
    AND LNRECB2.NU_SQNL = CRTO2.NU_SQNL
    AND CRTO2.CD_TIPO_CNCT_CRTO = 1
    AND LNRECB2.NU_RFRN = LNRMNR2.NU_RFRN
    AND LNRECB2.NU_RMSA_CRDE = LNRMNR2.NU_RMSA_CRDE
    AND LNRECB2.NU_RMSA_EMSR = LNRMNR2.NU_RMSA_EMSR
    AND LNRECB2.DT_RFRN_MVMN = LNRMNR2.DT_RFRN_MVMN
    AND LNRECB2.NU_SQNL = LNRMNR2.NU_SQNL -- NUMERO SEQUENCIAL INSERIDO COMO CHAVE
    AND LNRMNR2.CD_TIPO_TRNS_BNDR_RECB = '01'
    AND NVL(LNRECB2.NU_PRCL, 0) = NVL(LNRMNR2.NU_PRCL, 0)
columns: []
referencedTables: []
