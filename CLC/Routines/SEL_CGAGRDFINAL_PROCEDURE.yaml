schema: CLC
name: SEL_CGAGRDFINAL
routineType: PROCEDURE
returnParamater: null
parameters:
- name: VDATAMOVIMENTO
  ordinalPosition: 1
  dataType: DATE
  parameterMode: IN
- name: VCREDENCIADORA
  ordinalPosition: 2
  dataType: NUMBER
  parameterMode: IN
- name: VPLATAFORMA
  ordinalPosition: 3
  dataType: VARCHAR2
  parameterMode: IN
- name: VTIPOORIGEM
  ordinalPosition: 4
  dataType: VARCHAR2
  parameterMode: IN
routineDefinition: |-
  PROCEDURE SEL_CGAGRDFINAL(
    vdataMovimento IN DATE,
    vcredenciadora IN NUMBER,
    vplataforma IN VARCHAR,
    vtipoOrigem IN VARCHAR
  ) AS vdataMovimentoAux DATE;
  vlinhasRemumeracaoAux NUMBER;
  vlinhasEmissorAux NUMBER;
  BEGIN
    vdataMovimentoAux: = vdataMovimento;
  vlinhasEmissorAux: = 0;
  vlinhasRemumeracaoAux: = 0;
  IF vdataMovimentoAux IS NULL THEN
  SELECT
    TRUNC(dt_pcsm_atul) INTO vdataMovimentoAux
  FROM
    ccr.tbccrr_cicl_pcsm_cdst;
  END IF;
  SELECT
    COUNT(1) INTO vlinhasEmissorAux
  FROM
    CLC.TBCLCR_RCBM_AGND_EMSR
  WHERE
    DT_RFRN_MVMN = vdataMovimentoAux
    AND CD_TIPO_STCO_POCS_PGMN_LQDC = 5
    AND CD_FRNT_TBHO = 2;
  SELECT
    COUNT(1) INTO vlinhasRemumeracaoAux
  FROM
    CLC.TBCLCR_PGMN_COND_RMNR_GRDE
  WHERE
    DT_RFRN_MVMN = vdataMovimentoAux
    AND CD_TIPO_STCO_POCS_PGMN_LQDC = 5
    AND CD_FRNT_TBHO = 11;
  IF vtipoOrigem = 'CRD' THEN IF vlinhasEmissorAux = 0 THEN --DELETA OS DADOS EXISTENTES DA GRADE DA AG.EMISSOR
  DELETE FROM
    CLC.TBCLCR_RCBM_AGND_EMSR
  WHERE
    CD_CRDE = vcredenciadora
    AND CD_TIPO_PLTF_PGMN = vplataforma
    AND DT_RFRN_MVMN = vdataMovimentoAux --      AND   CD_TIPO_STCO_GRDE = 1
    AND CD_FRNT_TBHO = 2
    AND CD_CRDE <> 7253;
  --TRANSITORIO CIELO
    --POPULA NOVAMENTE OS DADOS DA AG.EMISSOR
  INSERT INTO
    CLC.TBCLCR_RCBM_AGND_EMSR (
      CD_BNDR,
      DT_VNCM_TRNS,
      NU_BNCO_LQDN,
      CD_TIPO_PLTF_PGMN,
      CD_CRDE,
      CD_EMSR,
      CD_PCSR,
      CD_MODA,
      CD_TIPO_STCO_GRDE,
      VL_LQDO_TRNS_ETNC,
      DH_INCL_RGST,
      CD_USRO_INCL_RGST,
      DT_RFRN_MVMN,
      CD_FRNT_TBHO,
      VL_AJST_GRDE,
      CD_TIPO_ACAO_RGST,
      CD_USRO_ACAO_RGST,
      CD_TIPO_STCO_POCS_PGMN_PCSM,
      CD_TIPO_STCO_POCS_PGMN_LQDC,
      TBC_DT_VNCM_TRNS,
      QT_TOTL_LNCM_BNDR,
      CD_CICL_LQDC_CIP
    )
  SELECT
    CD_BNDR,
    DT_VNCM_MVMN,
    NU_BNCO_LQDN,
    CD_TIPO_PLTF_PGMN,
    CD_CRDE,
    CD_EMSR,
    CD_PCSR,
    CD_MODA,
    1,
    SUM(
      case
        CD_TIPO_OPRD
        when 2 then (VL_TOTL_LNCM_BNDR - VL_ITCM_BNDR) * -1
        ELSE (VL_TOTL_LNCM_BNDR - VL_ITCM_BNDR)
      END
    ) * -1 AS valor_liquido,
    SYSDATE,
    'Grade Unificada',
    DT_RFRN_MVMN,
    2,
    NULL,
    'I',
    'Grade Unificada',
    1,
    1,
    NULL,
    SUM(QT_TRNS_ETNC),
    NULL
  FROM
    CLC.TBCLCR_LQDC_GRDE
  WHERE
    CD_CRDE = vcredenciadora
    AND CD_TIPO_PLTF_PGMN = vplataforma
    AND DT_RFRN_MVMN = vdataMovimentoAux
  GROUP BY
    CD_BNDR,
    DT_VNCM_MVMN,
    NU_BNCO_LQDN,
    CD_TIPO_PLTF_PGMN,
    CD_CRDE,
    CD_EMSR,
    CD_PCSR,
    CD_MODA,
    DT_RFRN_MVMN;
  END IF;
  IF vlinhasRemumeracaoAux = 0 THEN --DELETA OS DADOS EXISTENTES DA GRADE DA AG.REMUNERAÇÃO
  DELETE FROM
    CLC.TBCLCR_PGMN_COND_RMNR_GRDE
  WHERE
    CD_CRDE = vcredenciadora
    AND CD_TIPO_PLTF_PGMN = vplataforma
    AND DT_RFRN_MVMN = vdataMovimentoAux --      AND   CD_TIPO_STCO_GRDE = 1
    AND CD_FRNT_TBHO = 11
    AND CD_CRDE <> 7253;
  --TRANSITORIO CIELO
    --POPULA NOVAMENTE OS DADOS DA AG.REMUNERAÇÃO
  INSERT INTO
    CLC.TBCLCR_PGMN_COND_RMNR_GRDE (
      CD_BNDR,
      CD_CRDE,
      CD_TIPO_PLTF_PGMN,
      NU_BNCO_PGMN_CRDE,
      DT_RFRN_MVMN,
      DT_VNCM_TRNS,
      CD_TIPO_STCO_GRDE,
      VL_LQDO_COND_RMNR_BNDR,
      DH_INCL_RGST,
      CD_USRO_INCL_RGST,
      CD_FRNT_TBHO,
      VL_AJST_GRDE,
      CD_TIPO_ACAO_RGST,
      CD_USRO_ACAO_RGST,
      CD_TIPO_STCO_POCS_PGMN_PCSM,
      CD_TIPO_STCO_POCS_PGMN_LQDC,
      DT_VNCM_TRNS_ORIG,
      QT_TOTL_LNCM_BNDR
    )
  SELECT
    GRDE.CD_BNDR,
    GRDE.CD_CRDE,
    GRDE.CD_TIPO_PLTF_PGMN,
    CREDENCIADORA.NU_BNCO_PGMN_CRDE,
    GRDE.DT_RFRN_MVMN,
    GRDE.DT_VNCM_MVMN,
    1 AS CD_TIPO_STCO_GRDE,
    (
      DADOS_REMUNERACAO.valor_REM - DADOS_IMPOSTO.valor_TRIBUTO
    ) * -1 AS VALOR_LIQUIDO,
    sysdate AS DH_INCL_RGST,
    'Grade Unificada' AS CD_USRO_INCL_RGST,
    11 AS CD_FRNT_TBHO,
    null AS VL_AJST_GRDE,
    'I' AS CD_TIPO_ACAO_RGST,
    'Grade Unificada' AS CD_USRO_ACAO_RGST,
    1 AS CD_TIPO_STCO_POCS_PGMN_PCSM,
    1 AS CD_TIPO_STCO_POCS_PGMN_LQDC,
    null AS DT_VNCM_TRNS_ORIG,
    SUM(GRDE.QT_TRNS_ETNC) AS TOTAL_TRANSACOES
  FROM
    CLC.TBCLCR_LQDC_GRDE GRDE
    INNER JOIN (
      SELECT
        GERAL.CD_BNDR,
        GERAL.CD_CRDE,
        GERAL.CD_TIPO_PLTF_PGMN,
        GERAL.DT_RFRN_MVMN,
        GERAL.DT_VNCM_MVMN,
        SUM(
          case
            GERAL.CD_TIPO_OPRD
            when 2 then (COBRANCA.VL_RMNR_BNDR) * -1
            ELSE (COBRANCA.VL_RMNR_BNDR)
          END
        ) AS valor_REM
      FROM
        CLC.TBCLCR_LQDC_GRDE geral
        INNER JOIN CLC.TBCLCR_LQDC_GRDE_CBRN cobranca ON GERAL.CD_BNDR = COBRANCA.CD_BNDR
        AND GERAL.CD_CRDE = COBRANCA.CD_CRDE
        AND GERAL.CD_TIPO_PLTF_PGMN = COBRANCA.CD_TIPO_PLTF_PGMN
        AND GERAL.CD_EMSR = COBRANCA.CD_EMSR
        AND GERAL.CD_TIPO_TRNS_BNDR = COBRANCA.CD_TIPO_TRNS_BNDR
        AND GERAL.CD_PRDT_BNDR = COBRANCA.CD_PRDT_BNDR
        AND GERAL.CD_TIPO_TRNS_BNDR_ORGM = COBRANCA.CD_TIPO_TRNS_BNDR_ORGM
        AND GERAL.SG_ORGM_IFMC = COBRANCA.SG_ORGM_IFMC
        AND GERAL.DT_RFRN_MVMN = COBRANCA.DT_RFRN_MVMN
        AND GERAL.DT_VNCM_MVMN = COBRANCA.DT_VNCM_MVMN
        AND GERAL.NU_RMSA_CRDE = COBRANCA.NU_RMSA_CRDE
        AND GERAL.NU_RMSA_EMSR = COBRANCA.NU_RMSA_EMSR
        AND GERAL.CD_TIPO_APRS_TRNS = COBRANCA.CD_TIPO_APRS_TRNS
        AND GERAL.CD_PCSR = COBRANCA.CD_PCSR
        AND GERAL.CD_TIPO_RMNR_ITCM = COBRANCA.CD_TIPO_RMNR_ITCM
      WHERE
        GERAL.DT_RFRN_MVMN = vdataMovimentoAux
        and GERAL.CD_TIPO_PLTF_PGMN = vplataforma
        and GERAL.CD_CRDE = vcredenciadora
      GROUP BY
        GERAL.CD_BNDR,
        GERAL.CD_CRDE,
        GERAL.CD_TIPO_PLTF_PGMN,
        GERAL.DT_RFRN_MVMN,
        GERAL.DT_VNCM_MVMN
    ) DADOS_REMUNERACAO ON GRDE.CD_BNDR = DADOS_REMUNERACAO.CD_BNDR
    AND GRDE.CD_CRDE = DADOS_REMUNERACAO.CD_CRDE
    AND GRDE.CD_TIPO_PLTF_PGMN = DADOS_REMUNERACAO.CD_TIPO_PLTF_PGMN
    AND GRDE.DT_RFRN_MVMN = DADOS_REMUNERACAO.DT_RFRN_MVMN
    AND GRDE.DT_VNCM_MVMN = DADOS_REMUNERACAO.DT_VNCM_MVMN
    INNER JOIN (
      SELECT
        DADOS_IMP_AGRP_ROUND.CD_BNDR,
        DADOS_IMP_AGRP_ROUND.CD_CRDE,
        DADOS_IMP_AGRP_ROUND.CD_TIPO_PLTF_PGMN,
        DADOS_IMP_AGRP_ROUND.DT_RFRN_MVMN,
        DADOS_IMP_AGRP_ROUND.DT_VNCM_MVMN,
        SUM(DADOS_IMP_AGRP_ROUND.valor_TRIBUTO_AGRP) AS valor_TRIBUTO
      FROM
        (
          SELECT
            TRIBUTO.CD_BNDR,
            TRIBUTO.CD_CRDE,
            TRIBUTO.CD_TIPO_PLTF_PGMN,
            TRIBUTO.CD_EMSR,
            --TRIBUTO.CD_PCSR                ,
            TRIBUTO.CD_TIPO_TRNS_BNDR,
            TRIBUTO.CD_PRDT_BNDR,
            TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM,
            TRIBUTO.SG_ORGM_IFMC,
            TRIBUTO.DT_RFRN_MVMN,
            TRIBUTO.DT_VNCM_MVMN,
            TRIBUTO.CD_TIPO_APRS_TRNS,
            TRIBUTO.CD_TIPO_FOMA_CBRN_BNDR,
            TRIBUTO.CD_TRBT,
            TRIBUTO.CD_TIPO_ALQT_TRBT,
            ROUND(
              SUM(
                case
                  GERAL2.CD_TIPO_OPRD
                  when 2 then (TRIBUTO.VL_TRBT_RMNR_BNDR_VNDA) * -1
                  ELSE (TRIBUTO.VL_TRBT_RMNR_BNDR_VNDA)
                END
              ),
              2
            ) AS valor_TRIBUTO_AGRP
          FROM
            CLC.TBCLCR_LQDC_GRDE geral2
            INNER JOIN CLC.TBCLCR_LQDC_GRDE_CBRN cobranca2 ON GERAL2.CD_BNDR = COBRANCA2.CD_BNDR
            AND GERAL2.CD_CRDE = COBRANCA2.CD_CRDE
            AND GERAL2.CD_TIPO_PLTF_PGMN = COBRANCA2.CD_TIPO_PLTF_PGMN
            AND GERAL2.CD_EMSR = COBRANCA2.CD_EMSR
            AND GERAL2.CD_TIPO_TRNS_BNDR = COBRANCA2.CD_TIPO_TRNS_BNDR
            AND GERAL2.CD_PRDT_BNDR = COBRANCA2.CD_PRDT_BNDR
            AND GERAL2.CD_TIPO_TRNS_BNDR_ORGM = COBRANCA2.CD_TIPO_TRNS_BNDR_ORGM
            AND GERAL2.SG_ORGM_IFMC = COBRANCA2.SG_ORGM_IFMC
            AND GERAL2.DT_RFRN_MVMN = COBRANCA2.DT_RFRN_MVMN
            AND GERAL2.DT_VNCM_MVMN = COBRANCA2.DT_VNCM_MVMN
            AND GERAL2.NU_RMSA_CRDE = COBRANCA2.NU_RMSA_CRDE
            AND GERAL2.NU_RMSA_EMSR = COBRANCA2.NU_RMSA_EMSR
            AND GERAL2.CD_TIPO_APRS_TRNS = COBRANCA2.CD_TIPO_APRS_TRNS
            AND GERAL2.CD_PCSR = COBRANCA2.CD_PCSR
            AND GERAL2.CD_TIPO_RMNR_ITCM = COBRANCA2.CD_TIPO_RMNR_ITCM
            INNER JOIN CLC.TBCLCR_LQDC_GRDE_TRBT TRIBUTO ON TRIBUTO.CD_BNDR = COBRANCA2.CD_BNDR
            AND TRIBUTO.CD_CRDE = COBRANCA2.CD_CRDE
            AND TRIBUTO.CD_TIPO_PLTF_PGMN = COBRANCA2.CD_TIPO_PLTF_PGMN
            AND TRIBUTO.CD_EMSR = COBRANCA2.CD_EMSR
            AND TRIBUTO.CD_TIPO_TRNS_BNDR = COBRANCA2.CD_TIPO_TRNS_BNDR
            AND TRIBUTO.CD_PRDT_BNDR = COBRANCA2.CD_PRDT_BNDR
            AND TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM = COBRANCA2.CD_TIPO_TRNS_BNDR_ORGM
            AND TRIBUTO.SG_ORGM_IFMC = COBRANCA2.SG_ORGM_IFMC
            AND TRIBUTO.DT_RFRN_MVMN = COBRANCA2.DT_RFRN_MVMN
            AND TRIBUTO.DT_VNCM_MVMN = COBRANCA2.DT_VNCM_MVMN
            AND TRIBUTO.NU_RMSA_CRDE = COBRANCA2.NU_RMSA_CRDE
            AND TRIBUTO.NU_RMSA_EMSR = COBRANCA2.NU_RMSA_EMSR
            AND TRIBUTO.CD_TIPO_APRS_TRNS = COBRANCA2.CD_TIPO_APRS_TRNS
            AND TRIBUTO.CD_PCSR = COBRANCA2.CD_PCSR
            AND TRIBUTO.CD_TIPO_FOMA_CBRN_BNDR = COBRANCA2.CD_TIPO_FOMA_CBRN_BNDR
            AND TRIBUTO.CD_TIPO_RMNR_ITCM = COBRANCA2.CD_TIPO_RMNR_ITCM
          WHERE
            GERAL2.DT_RFRN_MVMN = vdataMovimentoAux
            and GERAL2.CD_TIPO_PLTF_PGMN = vplataforma
            AND GERAL2.CD_CRDE = vcredenciadora
            AND TRIBUTO.CD_TIPO_ALQT_TRBT = 2
          GROUP BY
            TRIBUTO.CD_BNDR,
            TRIBUTO.CD_CRDE,
            TRIBUTO.CD_TIPO_PLTF_PGMN,
            TRIBUTO.CD_EMSR,
            --TRIBUTO.CD_PCSR                ,
            TRIBUTO.CD_TIPO_TRNS_BNDR,
            TRIBUTO.CD_PRDT_BNDR,
            TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM,
            TRIBUTO.SG_ORGM_IFMC,
            TRIBUTO.DT_RFRN_MVMN,
            TRIBUTO.DT_VNCM_MVMN,
            TRIBUTO.CD_TIPO_APRS_TRNS,
            TRIBUTO.CD_TIPO_FOMA_CBRN_BNDR,
            TRIBUTO.CD_TRBT,
            TRIBUTO.CD_TIPO_ALQT_TRBT
        ) DADOS_IMP_AGRP_ROUND
      GROUP BY
        DADOS_IMP_AGRP_ROUND.CD_BNDR,
        DADOS_IMP_AGRP_ROUND.CD_CRDE,
        DADOS_IMP_AGRP_ROUND.CD_TIPO_PLTF_PGMN,
        DADOS_IMP_AGRP_ROUND.DT_RFRN_MVMN,
        DADOS_IMP_AGRP_ROUND.DT_VNCM_MVMN
    ) DADOS_IMPOSTO ON DADOS_IMPOSTO.CD_BNDR = DADOS_REMUNERACAO.CD_BNDR
    AND DADOS_IMPOSTO.CD_CRDE = DADOS_REMUNERACAO.CD_CRDE
    AND DADOS_IMPOSTO.CD_TIPO_PLTF_PGMN = DADOS_REMUNERACAO.CD_TIPO_PLTF_PGMN
    AND DADOS_IMPOSTO.DT_RFRN_MVMN = DADOS_REMUNERACAO.DT_RFRN_MVMN
    AND DADOS_IMPOSTO.DT_VNCM_MVMN = DADOS_REMUNERACAO.DT_VNCM_MVMN
    INNER JOIN CCR.TBCCRR_CRDE_BNDR CREDENCIADORA ON GRDE.CD_BNDR = CREDENCIADORA.CD_BNDR
    AND GRDE.CD_CRDE = CREDENCIADORA.CD_CRDE
  WHERE
    GRDE.DT_RFRN_MVMN = vdataMovimentoAux
    and GRDE.CD_TIPO_PLTF_PGMN = vplataforma
    and GRDE.CD_CRDE = vcredenciadora
  group by
    GRDE.CD_BNDR,
    GRDE.CD_CRDE,
    GRDE.CD_TIPO_PLTF_PGMN,
    GRDE.DT_RFRN_MVMN,
    GRDE.DT_VNCM_MVMN,
    CREDENCIADORA.NU_BNCO_PGMN_CRDE,
    DADOS_REMUNERACAO.valor_REM,
    DADOS_IMPOSTO.valor_TRIBUTO;
  END IF;
  ELSE --QUANDO FOR UMA EXECUÇÃO DO TIPO EMI, OS DADOS DE TODAS AS CREDENCIADORAS DEVEM SER DELETADOS E RECARREGADOS
  IF vlinhasEmissorAux = 0 THEN --DELETA OS DADOS EXISTENTES DA GRADE DA AG.EMISSOR
  DELETE FROM
    CLC.TBCLCR_RCBM_AGND_EMSR
  WHERE
    DT_RFRN_MVMN = vdataMovimentoAux --      AND   CD_TIPO_STCO_GRDE = 1
    AND CD_FRNT_TBHO = 2
    AND CD_CRDE <> 7253;
  --TRANSITORIO CIELO
    --CARREGA NOVAMENTE OS DADOS DA AG.EMISSOR
  INSERT INTO
    CLC.TBCLCR_RCBM_AGND_EMSR (
      CD_BNDR,
      DT_VNCM_TRNS,
      NU_BNCO_LQDN,
      CD_TIPO_PLTF_PGMN,
      CD_CRDE,
      CD_EMSR,
      CD_PCSR,
      CD_MODA,
      CD_TIPO_STCO_GRDE,
      VL_LQDO_TRNS_ETNC,
      DH_INCL_RGST,
      CD_USRO_INCL_RGST,
      DT_RFRN_MVMN,
      CD_FRNT_TBHO,
      VL_AJST_GRDE,
      CD_TIPO_ACAO_RGST,
      CD_USRO_ACAO_RGST,
      CD_TIPO_STCO_POCS_PGMN_PCSM,
      CD_TIPO_STCO_POCS_PGMN_LQDC,
      TBC_DT_VNCM_TRNS,
      QT_TOTL_LNCM_BNDR,
      CD_CICL_LQDC_CIP
    )
  SELECT
    CD_BNDR,
    DT_VNCM_MVMN,
    NU_BNCO_LQDN,
    CD_TIPO_PLTF_PGMN,
    CD_CRDE,
    CD_EMSR,
    CD_PCSR,
    CD_MODA,
    1,
    SUM(
      case
        CD_TIPO_OPRD
        when 2 then (VL_TOTL_LNCM_BNDR - VL_ITCM_BNDR) * -1
        ELSE (VL_TOTL_LNCM_BNDR - VL_ITCM_BNDR)
      END
    ) * -1 AS valor_liquido,
    SYSDATE,
    'Grade Unificada',
    DT_RFRN_MVMN,
    2,
    NULL,
    'I',
    'Grade Unificada',
    1,
    1,
    NULL,
    SUM(QT_TRNS_ETNC),
    NULL
  FROM
    CLC.TBCLCR_LQDC_GRDE
  WHERE
    DT_RFRN_MVMN = vdataMovimentoAux
  GROUP BY
    CD_BNDR,
    DT_VNCM_MVMN,
    NU_BNCO_LQDN,
    CD_TIPO_PLTF_PGMN,
    CD_CRDE,
    CD_EMSR,
    CD_PCSR,
    CD_MODA,
    DT_RFRN_MVMN;
  END IF;
  IF vlinhasRemumeracaoAux = 0 THEN --DELETA OS DADOS EXISTENTES DA GRADE DA AG.REMUNERAÇÃO
  DELETE FROM
    CLC.TBCLCR_PGMN_COND_RMNR_GRDE
  WHERE
    DT_RFRN_MVMN = vdataMovimentoAux --      AND   CD_TIPO_STCO_GRDE = 1
    AND CD_FRNT_TBHO = 11
    AND CD_CRDE <> 7253;
  --TRANSITORIO CIELO
    --POPULA NOVAMENTE OS DADOS DA AG.REMUNERAÇÃO
  INSERT INTO
    CLC.TBCLCR_PGMN_COND_RMNR_GRDE (
      CD_BNDR,
      CD_CRDE,
      CD_TIPO_PLTF_PGMN,
      NU_BNCO_PGMN_CRDE,
      DT_RFRN_MVMN,
      DT_VNCM_TRNS,
      CD_TIPO_STCO_GRDE,
      VL_LQDO_COND_RMNR_BNDR,
      DH_INCL_RGST,
      CD_USRO_INCL_RGST,
      CD_FRNT_TBHO,
      VL_AJST_GRDE,
      CD_TIPO_ACAO_RGST,
      CD_USRO_ACAO_RGST,
      CD_TIPO_STCO_POCS_PGMN_PCSM,
      CD_TIPO_STCO_POCS_PGMN_LQDC,
      DT_VNCM_TRNS_ORIG,
      QT_TOTL_LNCM_BNDR
    )
  SELECT
    GRDE.CD_BNDR,
    GRDE.CD_CRDE,
    GRDE.CD_TIPO_PLTF_PGMN,
    CREDENCIADORA.NU_BNCO_PGMN_CRDE,
    GRDE.DT_RFRN_MVMN,
    GRDE.DT_VNCM_MVMN,
    1 AS CD_TIPO_STCO_GRDE,
    (
      DADOS_REMUNERACAO.valor_REM - DADOS_IMPOSTO.valor_TRIBUTO
    ) * -1 AS VALOR_LIQUIDO,
    sysdate AS DH_INCL_RGST,
    'Grade Unificada' AS CD_USRO_INCL_RGST,
    11 AS CD_FRNT_TBHO,
    null AS VL_AJST_GRDE,
    'I' AS CD_TIPO_ACAO_RGST,
    'Grade Unificada' AS CD_USRO_ACAO_RGST,
    1 AS CD_TIPO_STCO_POCS_PGMN_PCSM,
    1 AS CD_TIPO_STCO_POCS_PGMN_LQDC,
    null AS DT_VNCM_TRNS_ORIG,
    SUM(GRDE.QT_TRNS_ETNC) AS TOTAL_TRANSACOES
  FROM
    CLC.TBCLCR_LQDC_GRDE GRDE
    INNER JOIN (
      SELECT
        GERAL.CD_BNDR,
        GERAL.CD_CRDE,
        GERAL.CD_TIPO_PLTF_PGMN,
        GERAL.DT_RFRN_MVMN,
        GERAL.DT_VNCM_MVMN,
        SUM(
          case
            GERAL.CD_TIPO_OPRD
            when 2 then (COBRANCA.VL_RMNR_BNDR) * -1
            ELSE (COBRANCA.VL_RMNR_BNDR)
          END
        ) AS valor_REM
      FROM
        CLC.TBCLCR_LQDC_GRDE geral
        INNER JOIN CLC.TBCLCR_LQDC_GRDE_CBRN cobranca ON GERAL.CD_BNDR = COBRANCA.CD_BNDR
        AND GERAL.CD_CRDE = COBRANCA.CD_CRDE
        AND GERAL.CD_TIPO_PLTF_PGMN = COBRANCA.CD_TIPO_PLTF_PGMN
        AND GERAL.CD_EMSR = COBRANCA.CD_EMSR
        AND GERAL.CD_TIPO_TRNS_BNDR = COBRANCA.CD_TIPO_TRNS_BNDR
        AND GERAL.CD_PRDT_BNDR = COBRANCA.CD_PRDT_BNDR
        AND GERAL.CD_TIPO_TRNS_BNDR_ORGM = COBRANCA.CD_TIPO_TRNS_BNDR_ORGM
        AND GERAL.SG_ORGM_IFMC = COBRANCA.SG_ORGM_IFMC
        AND GERAL.DT_RFRN_MVMN = COBRANCA.DT_RFRN_MVMN
        AND GERAL.DT_VNCM_MVMN = COBRANCA.DT_VNCM_MVMN
        AND GERAL.NU_RMSA_CRDE = COBRANCA.NU_RMSA_CRDE
        AND GERAL.NU_RMSA_EMSR = COBRANCA.NU_RMSA_EMSR
        AND GERAL.CD_TIPO_APRS_TRNS = COBRANCA.CD_TIPO_APRS_TRNS
        AND GERAL.CD_PCSR = COBRANCA.CD_PCSR
        AND GERAL.CD_TIPO_RMNR_ITCM = COBRANCA.CD_TIPO_RMNR_ITCM
      WHERE
        GERAL.DT_RFRN_MVMN = vdataMovimentoAux
      GROUP BY
        GERAL.CD_BNDR,
        GERAL.CD_CRDE,
        GERAL.CD_TIPO_PLTF_PGMN,
        GERAL.DT_RFRN_MVMN,
        GERAL.DT_VNCM_MVMN
    ) DADOS_REMUNERACAO ON GRDE.CD_BNDR = DADOS_REMUNERACAO.CD_BNDR
    AND GRDE.CD_CRDE = DADOS_REMUNERACAO.CD_CRDE
    AND GRDE.CD_TIPO_PLTF_PGMN = DADOS_REMUNERACAO.CD_TIPO_PLTF_PGMN
    AND GRDE.DT_RFRN_MVMN = DADOS_REMUNERACAO.DT_RFRN_MVMN
    AND GRDE.DT_VNCM_MVMN = DADOS_REMUNERACAO.DT_VNCM_MVMN
    INNER JOIN (
      SELECT
        DADOS_IMP_AGRP_ROUND.CD_BNDR,
        DADOS_IMP_AGRP_ROUND.CD_CRDE,
        DADOS_IMP_AGRP_ROUND.CD_TIPO_PLTF_PGMN,
        DADOS_IMP_AGRP_ROUND.DT_RFRN_MVMN,
        DADOS_IMP_AGRP_ROUND.DT_VNCM_MVMN,
        SUM(DADOS_IMP_AGRP_ROUND.valor_TRIBUTO_AGRP) AS valor_TRIBUTO
      FROM
        (
          SELECT
            TRIBUTO.CD_BNDR,
            TRIBUTO.CD_CRDE,
            TRIBUTO.CD_TIPO_PLTF_PGMN,
            TRIBUTO.CD_EMSR,
            --TRIBUTO.CD_PCSR                ,
            (
              CASE
                TRIBUTO.NU_RMSA_EMSR
                WHEN 0 then TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM
                else TRIBUTO.CD_TIPO_TRNS_BNDR
              end
            ) AS CD_TIPO_TRNS_BNDR,
            TRIBUTO.CD_PRDT_BNDR,
            TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM,
            TRIBUTO.SG_ORGM_IFMC,
            TRIBUTO.DT_RFRN_MVMN,
            TRIBUTO.DT_VNCM_MVMN,
            TRIBUTO.CD_TIPO_APRS_TRNS,
            TRIBUTO.CD_TIPO_FOMA_CBRN_BNDR,
            TRIBUTO.CD_TRBT,
            TRIBUTO.CD_TIPO_ALQT_TRBT,
            ROUND(
              SUM(
                case
                  GERAL2.CD_TIPO_OPRD
                  when 2 then (TRIBUTO.VL_TRBT_RMNR_BNDR_VNDA) * -1
                  ELSE (TRIBUTO.VL_TRBT_RMNR_BNDR_VNDA)
                END
              ),
              2
            ) AS valor_TRIBUTO_AGRP
          FROM
            CLC.TBCLCR_LQDC_GRDE geral2
            INNER JOIN CLC.TBCLCR_LQDC_GRDE_CBRN cobranca2 ON GERAL2.CD_BNDR = COBRANCA2.CD_BNDR
            AND GERAL2.CD_CRDE = COBRANCA2.CD_CRDE
            AND GERAL2.CD_TIPO_PLTF_PGMN = COBRANCA2.CD_TIPO_PLTF_PGMN
            AND GERAL2.CD_EMSR = COBRANCA2.CD_EMSR
            AND GERAL2.CD_TIPO_TRNS_BNDR = COBRANCA2.CD_TIPO_TRNS_BNDR
            AND GERAL2.CD_PRDT_BNDR = COBRANCA2.CD_PRDT_BNDR
            AND GERAL2.CD_TIPO_TRNS_BNDR_ORGM = COBRANCA2.CD_TIPO_TRNS_BNDR_ORGM
            AND GERAL2.SG_ORGM_IFMC = COBRANCA2.SG_ORGM_IFMC
            AND GERAL2.DT_RFRN_MVMN = COBRANCA2.DT_RFRN_MVMN
            AND GERAL2.DT_VNCM_MVMN = COBRANCA2.DT_VNCM_MVMN
            AND GERAL2.NU_RMSA_CRDE = COBRANCA2.NU_RMSA_CRDE
            AND GERAL2.NU_RMSA_EMSR = COBRANCA2.NU_RMSA_EMSR
            AND GERAL2.CD_TIPO_APRS_TRNS = COBRANCA2.CD_TIPO_APRS_TRNS
            AND GERAL2.CD_PCSR = COBRANCA2.CD_PCSR
            AND GERAL2.CD_TIPO_RMNR_ITCM = COBRANCA2.CD_TIPO_RMNR_ITCM
            INNER JOIN CLC.TBCLCR_LQDC_GRDE_TRBT TRIBUTO ON TRIBUTO.CD_BNDR = COBRANCA2.CD_BNDR
            AND TRIBUTO.CD_CRDE = COBRANCA2.CD_CRDE
            AND TRIBUTO.CD_TIPO_PLTF_PGMN = COBRANCA2.CD_TIPO_PLTF_PGMN
            AND TRIBUTO.CD_EMSR = COBRANCA2.CD_EMSR
            AND TRIBUTO.CD_TIPO_TRNS_BNDR = COBRANCA2.CD_TIPO_TRNS_BNDR
            AND TRIBUTO.CD_PRDT_BNDR = COBRANCA2.CD_PRDT_BNDR
            AND TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM = COBRANCA2.CD_TIPO_TRNS_BNDR_ORGM
            AND TRIBUTO.SG_ORGM_IFMC = COBRANCA2.SG_ORGM_IFMC
            AND TRIBUTO.DT_RFRN_MVMN = COBRANCA2.DT_RFRN_MVMN
            AND TRIBUTO.DT_VNCM_MVMN = COBRANCA2.DT_VNCM_MVMN
            AND TRIBUTO.NU_RMSA_CRDE = COBRANCA2.NU_RMSA_CRDE
            AND TRIBUTO.NU_RMSA_EMSR = COBRANCA2.NU_RMSA_EMSR
            AND TRIBUTO.CD_TIPO_APRS_TRNS = COBRANCA2.CD_TIPO_APRS_TRNS
            AND TRIBUTO.CD_PCSR = COBRANCA2.CD_PCSR
            AND TRIBUTO.CD_TIPO_FOMA_CBRN_BNDR = COBRANCA2.CD_TIPO_FOMA_CBRN_BNDR
            AND TRIBUTO.CD_TIPO_RMNR_ITCM = COBRANCA2.CD_TIPO_RMNR_ITCM
          WHERE
            GERAL2.DT_RFRN_MVMN = vdataMovimentoAux
            AND TRIBUTO.CD_TIPO_ALQT_TRBT = 2
          GROUP BY
            TRIBUTO.CD_BNDR,
            TRIBUTO.CD_CRDE,
            TRIBUTO.CD_TIPO_PLTF_PGMN,
            TRIBUTO.CD_EMSR,
            --TRIBUTO.CD_PCSR                ,
            (
              CASE
                TRIBUTO.NU_RMSA_EMSR
                WHEN 0 then TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM
                else TRIBUTO.CD_TIPO_TRNS_BNDR
              end
            ),
            TRIBUTO.CD_PRDT_BNDR,
            TRIBUTO.CD_TIPO_TRNS_BNDR_ORGM,
            TRIBUTO.SG_ORGM_IFMC,
            TRIBUTO.DT_RFRN_MVMN,
            TRIBUTO.DT_VNCM_MVMN,
            TRIBUTO.CD_TIPO_APRS_TRNS,
            TRIBUTO.CD_TIPO_FOMA_CBRN_BNDR,
            TRIBUTO.CD_TRBT,
            TRIBUTO.CD_TIPO_ALQT_TRBT
        ) DADOS_IMP_AGRP_ROUND
      GROUP BY
        DADOS_IMP_AGRP_ROUND.CD_BNDR,
        DADOS_IMP_AGRP_ROUND.CD_CRDE,
        DADOS_IMP_AGRP_ROUND.CD_TIPO_PLTF_PGMN,
        DADOS_IMP_AGRP_ROUND.DT_RFRN_MVMN,
        DADOS_IMP_AGRP_ROUND.DT_VNCM_MVMN
    ) DADOS_IMPOSTO ON DADOS_IMPOSTO.CD_BNDR = DADOS_REMUNERACAO.CD_BNDR
    AND DADOS_IMPOSTO.CD_CRDE = DADOS_REMUNERACAO.CD_CRDE
    AND DADOS_IMPOSTO.CD_TIPO_PLTF_PGMN = DADOS_REMUNERACAO.CD_TIPO_PLTF_PGMN
    AND DADOS_IMPOSTO.DT_RFRN_MVMN = DADOS_REMUNERACAO.DT_RFRN_MVMN
    AND DADOS_IMPOSTO.DT_VNCM_MVMN = DADOS_REMUNERACAO.DT_VNCM_MVMN
    INNER JOIN CCR.TBCCRR_CRDE_BNDR CREDENCIADORA ON GRDE.CD_BNDR = CREDENCIADORA.CD_BNDR
    AND GRDE.CD_CRDE = CREDENCIADORA.CD_CRDE
  WHERE
    GRDE.DT_RFRN_MVMN = vdataMovimentoAux
  group by
    GRDE.CD_BNDR,
    GRDE.CD_CRDE,
    GRDE.CD_TIPO_PLTF_PGMN,
    GRDE.DT_RFRN_MVMN,
    GRDE.DT_VNCM_MVMN,
    CREDENCIADORA.NU_BNCO_PGMN_CRDE,
    DADOS_REMUNERACAO.valor_REM,
    DADOS_IMPOSTO.valor_TRIBUTO;
  END IF;
  END IF;
  COMMIT;
  EXCEPTION
    WHEN OTHERS THEN RAISE_APPLICATION_ERROR(-20001, SQLCODE || ': ' || SQLERRM);
  ROLLBACK;
  END SEL_CGAGRDFINAL;
