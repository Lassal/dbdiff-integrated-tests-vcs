schema: CLC
name: SEL_CGAGRDEMISSOR0612
routineType: PROCEDURE
returnParamater: null
parameters:
- name: VDATAMOVIMENTO
  ordinalPosition: 1
  dataType: DATE
  parameterMode: INOUT
- name: CURSOR_
  ordinalPosition: 2
  dataType: REF CURSOR
  parameterMode: OUT
routineDefinition: |-
  PROCEDURE SEL_CGAGRDEMISSOR0612 (
    vdataMovimento IN OUT DATE,
    cursor_ OUT SYS_REFCURSOR
  ) AS vdataMovimentoAux DATE;
  BEGIN
    vdataMovimentoAux: = vdataMovimento;
  IF vdataMovimentoAux IS NULL THEN
  SELECT
    TRUNC(dt_pcsm_atul) INTO vdataMovimentoAux
  FROM
    ccr.tbccrr_cicl_pcsm_cdst;
  END IF;
  OPEN cursor_ FOR
  SELECT
    /*+ INDEX_ASC(REMUNERACAO ICLCR_LNCM_RECB_RMNR_05) */
    LANCAMENTO.CD_BNDR,
    LANCAMENTO.CD_CRDE,
    LANCAMENTO.CD_TIPO_PLTF_PGMN,
    LANCAMENTO.CD_EMSR,
    LANCAMENTO.CD_PCSR,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB,
    LANCAMENTO.CD_PRDT_BNDR_RECB,
    '01' AS CD_TIPO_TRNS_BNDR,
    'EMI' AS SG_ORGM_IFMC_RECB,
    LANCAMENTO.DT_RERO_EMSR AS DT_RFRN_MVMN,
    REMUNERACAO.DT_VNCM_LQDC_EMSR,
    LANCAMENTO.NU_RMSA_CRDE,
    LANCAMENTO.NU_RMSA_EMSR,
    LANCAMENTO.CD_MODA_RECB,
    OPERADOR.CD_TIPO_OPRD,
    LANCAMENTO.CD_TIPO_APRS_TRNS_RECB,
    BIN.NU_BNCO_LQDN,
    COBRANCA.CD_TIPO_FOMA_CBRN_BNDR,
    COUNT(1) AS QT_TRANSACOES,
    SUM(LANCAMENTO.TX_VALR_VNDA) / 100 AS VALOR_TRANSACOES,
    SUM(REMUNERACAO.VL_ITCM_VNDA) AS VALOR_INTERCAMBIO,
    SUM(COBRANCA.VL_RMNR_BNDR_VNDA) AS VL_RMNR_BNDR_VNDA
  FROM
    CLC.TBCLCR_LNCM_RECB LANCAMENTO,
    CLC.TBCLCR_LNCM_RECB_RMNR REMUNERACAO,
    CLC.TBCLCR_LNCM_RECB_RMNR_CBRN COBRANCA,
    CLC.TBCLCR_TIPO_TRNS_OPRD OPERADOR,
    CEM.TBCEMR_BIN_PLTF_ATZC_LQDC BIN
  WHERE
    LANCAMENTO.CD_BNDR = REMUNERACAO.CD_BNDR
    AND LANCAMENTO.DT_RFRN_MVMN = REMUNERACAO.DT_RFRN_MVMN
    AND LANCAMENTO.CD_TIPO_PLTF_PGMN = REMUNERACAO.CD_TIPO_PLTF_PGMN
    AND LANCAMENTO.CD_CRDE = REMUNERACAO.CD_CRDE
    AND LANCAMENTO.NU_RMSA_CRDE = REMUNERACAO.NU_RMSA_CRDE
    AND LANCAMENTO.CD_EMSR = REMUNERACAO.CD_EMSR
    AND LANCAMENTO.CD_PCSR = REMUNERACAO.CD_PCSR
    AND LANCAMENTO.NU_RMSA_EMSR = REMUNERACAO.NU_RMSA_EMSR
    AND LANCAMENTO.NU_SQNL = REMUNERACAO.NU_SQNL
    AND NVL(LANCAMENTO.NU_RFRN, 0) = REMUNERACAO.NU_RFRN
    AND REMUNERACAO.CD_TIPO_TRNS_BNDR_RECB = '01'
    AND REMUNERACAO.CD_BNDR = COBRANCA.CD_BNDR(+)
    AND REMUNERACAO.DT_RFRN_MVMN = COBRANCA.DT_RFRN_MVMN(+)
    AND REMUNERACAO.CD_TIPO_PLTF_PGMN = COBRANCA.CD_TIPO_PLTF_PGMN(+)
    AND REMUNERACAO.CD_CRDE = COBRANCA.CD_CRDE(+)
    AND REMUNERACAO.NU_RMSA_CRDE = COBRANCA.NU_RMSA_CRDE(+)
    AND REMUNERACAO.CD_EMSR = COBRANCA.CD_EMSR(+)
    AND REMUNERACAO.CD_PCSR = COBRANCA.CD_PCSR(+)
    AND REMUNERACAO.NU_RMSA_EMSR = COBRANCA.NU_RMSA_EMSR(+)
    AND REMUNERACAO.NU_SQNL = COBRANCA.NU_SQNL(+)
    AND REMUNERACAO.NU_RFRN = COBRANCA.NU_RFRN(+)
    AND REMUNERACAO.CD_TIPO_TRNS_BNDR_RECB = COBRANCA.CD_TIPO_TRNS_BNDR_RECB(+)
    AND LANCAMENTO.CD_ERRO_PCSM_LQDC_RECB >= CHR(0)
    AND OPERADOR.CD_BNDR = LANCAMENTO.CD_BNDR
    AND OPERADOR.CD_TIPO_TRNS_BNDR = 1
    AND OPERADOR.CD_TIPO_TRNS_BNDR_ORGM = LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB
    AND OPERADOR.SG_ORGM_IFMC = LANCAMENTO.SG_ORGM_IFMC_RECB
    AND LANCAMENTO.DT_RERO_EMSR = vdataMovimentoAux
    AND BIN.CD_BNDR = LANCAMENTO.CD_BNDR
    AND BIN.NU_BIN = REGEXP_SUBSTR(
      LANCAMENTO.CD_RASD_CICL_VIDA_TRNS,
      '[\.]?([^.]*)|NULL[\.]?',
      1,
      5,
      NULL,
      1
    )
    AND BIN.CD_EMSR = LANCAMENTO.CD_EMSR
    AND BIN.CD_TIPO_PLTF_PGMN = LANCAMENTO.CD_TIPO_PLTF_PGMN
  GROUP BY
    LANCAMENTO.CD_BNDR,
    LANCAMENTO.CD_CRDE,
    LANCAMENTO.CD_TIPO_PLTF_PGMN,
    LANCAMENTO.CD_EMSR,
    LANCAMENTO.CD_PCSR,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB,
    LANCAMENTO.CD_PRDT_BNDR_RECB,
    LANCAMENTO.DT_RFRN_MVMN,
    '01',
    REMUNERACAO.DT_VNCM_LQDC_EMSR,
    'EMI',
    LANCAMENTO.NU_RMSA_CRDE,
    LANCAMENTO.DT_RERO_EMSR,
    LANCAMENTO.NU_RMSA_EMSR,
    LANCAMENTO.CD_MODA_RECB,
    OPERADOR.CD_TIPO_OPRD,
    LANCAMENTO.CD_TIPO_APRS_TRNS_RECB,
    BIN.NU_BNCO_LQDN,
    COBRANCA.CD_TIPO_FOMA_CBRN_BNDR
  UNION ALL
  SELECT
    LANCAMENTO.CD_BNDR,
    LANCAMENTO.CD_CRDE,
    LANCAMENTO.CD_TIPO_PLTF_PGMN,
    LANCAMENTO.CD_EMSR,
    LANCAMENTO.CD_PCSR,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB,
    LANCAMENTO.CD_PRDT_BNDR_RECB,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB AS CD_TIPO_TRNS_BNDR,
    LANCAMENTO.SG_ORGM_IFMC_RECB,
    LANCAMENTO.DT_RFRN_MVMN,
    REMUNERACAO.DT_VNCM_LQDC_EMSR,
    LANCAMENTO.NU_RMSA_CRDE,
    LANCAMENTO.NU_RMSA_EMSR,
    LANCAMENTO.CD_MODA_RECB,
    OPERADOR.CD_TIPO_OPRD,
    LANCAMENTO.CD_TIPO_APRS_TRNS_RECB,
    BIN.NU_BNCO_LQDN,
    COBRANCA.CD_TIPO_FOMA_CBRN_BNDR,
    COUNT(1) AS QT_TRANSACOES,
    SUM(LANCAMENTO.TX_VALR_VNDA) / 100 AS VALOR_TRANSACOES,
    SUM(REMUNERACAO.VL_ITCM_VNDA) AS VALOR_INTERCAMBIO,
    SUM(COBRANCA.VL_RMNR_BNDR_VNDA) AS VL_RMNR_BNDR_VNDA
  FROM
    CLC.TBCLCR_LNCM_RECB LANCAMENTO,
    CLC.TBCLCR_LNCM_RECB_RMNR REMUNERACAO,
    CLC.TBCLCR_LNCM_RECB_RMNR_CBRN COBRANCA,
    CLC.TBCLCR_TIPO_TRNS_OPRD OPERADOR,
    CEM.TBCEMR_BIN_PLTF_ATZC_LQDC BIN
  WHERE
    LANCAMENTO.CD_BNDR = REMUNERACAO.CD_BNDR
    AND LANCAMENTO.DT_RFRN_MVMN = REMUNERACAO.DT_RFRN_MVMN
    AND LANCAMENTO.CD_TIPO_PLTF_PGMN = REMUNERACAO.CD_TIPO_PLTF_PGMN
    AND LANCAMENTO.CD_CRDE = REMUNERACAO.CD_CRDE
    AND LANCAMENTO.NU_RMSA_CRDE = REMUNERACAO.NU_RMSA_CRDE
    AND LANCAMENTO.CD_EMSR = REMUNERACAO.CD_EMSR
    AND LANCAMENTO.CD_PCSR = REMUNERACAO.CD_PCSR
    AND LANCAMENTO.NU_RMSA_EMSR = REMUNERACAO.NU_RMSA_EMSR
    AND LANCAMENTO.NU_SQNL = REMUNERACAO.NU_SQNL
    AND NVL(LANCAMENTO.NU_RFRN, 0) = REMUNERACAO.NU_RFRN
    AND REMUNERACAO.CD_TIPO_TRNS_BNDR_RECB = LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB
    AND REMUNERACAO.CD_BNDR = COBRANCA.CD_BNDR
    AND REMUNERACAO.DT_RFRN_MVMN = COBRANCA.DT_RFRN_MVMN
    AND REMUNERACAO.CD_TIPO_PLTF_PGMN = COBRANCA.CD_TIPO_PLTF_PGMN
    AND REMUNERACAO.CD_CRDE = COBRANCA.CD_CRDE
    AND REMUNERACAO.NU_RMSA_CRDE = COBRANCA.NU_RMSA_CRDE
    AND REMUNERACAO.CD_EMSR = COBRANCA.CD_EMSR
    AND REMUNERACAO.CD_PCSR = COBRANCA.CD_PCSR
    AND REMUNERACAO.NU_RMSA_EMSR = COBRANCA.NU_RMSA_EMSR
    AND REMUNERACAO.NU_SQNL = COBRANCA.NU_SQNL
    AND REMUNERACAO.NU_RFRN = COBRANCA.NU_RFRN
    AND REMUNERACAO.CD_TIPO_TRNS_BNDR_RECB = COBRANCA.CD_TIPO_TRNS_BNDR_RECB
    AND OPERADOR.CD_BNDR = LANCAMENTO.CD_BNDR
    AND OPERADOR.CD_TIPO_TRNS_BNDR = LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB
    AND OPERADOR.CD_TIPO_TRNS_BNDR_ORGM = LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB
    AND OPERADOR.SG_ORGM_IFMC = LANCAMENTO.SG_ORGM_IFMC_RECB
    AND LANCAMENTO.DT_RFRN_MVMN = vdataMovimentoAux
    AND REMUNERACAO.DT_RFRN_MVMN = vdataMovimentoAux
    AND COBRANCA.DT_RFRN_MVMN(+) = vdataMovimentoAux
    AND LANCAMENTO.SG_ORGM_IFMC_RECB = 'EMI'
    AND BIN.CD_BNDR = LANCAMENTO.CD_BNDR
    AND BIN.NU_BIN = REGEXP_SUBSTR(
      LANCAMENTO.CD_RASD_CICL_VIDA_TRNS,
      '[\.]?([^.]*)|NULL[\.]?',
      1,
      5,
      NULL,
      1
    )
    AND BIN.CD_EMSR = LANCAMENTO.CD_EMSR
    AND BIN.CD_TIPO_PLTF_PGMN = LANCAMENTO.CD_TIPO_PLTF_PGMN
    AND LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB <> '40'
  GROUP BY
    LANCAMENTO.CD_BNDR,
    LANCAMENTO.CD_CRDE,
    LANCAMENTO.CD_TIPO_PLTF_PGMN,
    LANCAMENTO.CD_EMSR,
    LANCAMENTO.CD_PCSR,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB,
    LANCAMENTO.CD_PRDT_BNDR_RECB,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB,
    LANCAMENTO.CD_TIPO_TRNS_BNDR_RECB,
    LANCAMENTO.SG_ORGM_IFMC_RECB,
    LANCAMENTO.DT_RFRN_MVMN,
    REMUNERACAO.DT_VNCM_LQDC_EMSR,
    LANCAMENTO.NU_RMSA_CRDE,
    LANCAMENTO.NU_RMSA_EMSR,
    LANCAMENTO.CD_MODA_RECB,
    OPERADOR.CD_TIPO_OPRD,
    LANCAMENTO.CD_TIPO_APRS_TRNS_RECB,
    BIN.NU_BNCO_LQDN,
    COBRANCA. CD_TIPO_FOMA_CBRN_BNDR
  UNION ALL
  SELECT
    lancamento.cd_bndr,
    lancamento.cd_crde,
    lancamento.CD_TIPO_PLTF_PGMN,
    lancamento.CD_EMSR,
    lancamento.CD_PCSR,
    lancamento.cd_tipo_trns_bndr_recb,
    lancamento.CD_PRDT_BNDR_RECB,
    lancamento.cd_tipo_trns_bndr_recb as cd_tipo_trns_bndr,
    lancamento.SG_ORGM_IFMC_RECB,
    lancamento.DT_RFRN_MVMN,
    remuneracao.DT_VNCM_LQDC_EMSR,
    lancamento.nu_rmsa_crde,
    lancamento.nu_rmsa_emsr,
    lancamento.CD_MODA_RECB,
    operador.CD_TIPO_OPRD,
    lancamento.CD_TIPO_APRS_TRNS_RECB,
    bin.NU_BNCO_LQDN,
    0,
    count(
      CASE
        WHEN CAST(NVL(lancamento.CD_RGRA_OPRC_TRNS, '0') AS INT) BETWEEN 0
        and 993 THEN lancamento.NU_PRCL
      end
    ) AS qt_transacoes,
    SUM(
      lancamento.TX_VALR_VNDA + TX_VALR_TAXA_EMBQ + TX_VALR_ORGM_TRNE_FNDO
    ) / 100 as valor_transacoes,
    NVL(0, SUM(remuneracao.VL_ITCM_VNDA)) AS valor_intercambio,
    0
  FROM
    CLC.TBCLCR_LNCM_RECB lancamento,
    CLC.TBCLCR_LNCM_RECB_RMNR remuneracao,
    CLC.TBCLCR_TIPO_TRNS_OPRD operador,
    CEM.TBCEMR_BIN_PLTF_ATZC_LQDC bin,
    CLC.TBCLCR_CRTO_CRPT_LNCM_RECB cripto
  WHERE
    lancamento.cd_bndr = remuneracao.cd_bndr
    AND lancamento.dt_rfrn_mvmn = remuneracao.dt_rfrn_mvmn
    AND lancamento.cd_tipo_pltf_pgmn = remuneracao.cd_tipo_pltf_pgmn
    AND lancamento.cd_crde = remuneracao.cd_crde
    AND lancamento.nu_rmsa_crde = remuneracao.nu_rmsa_crde
    AND lancamento.cd_emsr = remuneracao.cd_emsr
    AND lancamento.cd_pcsr = remuneracao.cd_pcsr
    AND lancamento.nu_rmsa_emsr = remuneracao.nu_rmsa_emsr
    AND lancamento.nu_sqnl = remuneracao.nu_sqnl
    AND NVL(lancamento.nu_rfrn, 0) = remuneracao.nu_rfrn
    AND remuneracao.cd_tipo_trns_bndr_recb = lancamento.cd_tipo_trns_bndr_recb
    AND operador.cd_bndr = lancamento.cd_bndr
    AND operador.cd_tipo_trns_bndr = lancamento.CD_TIPO_TRNS_BNDR_recb
    AND operador.CD_TIPO_TRNS_BNDR_ORGM = lancamento.CD_TIPO_TRNS_BNDR_recb
    AND operador.sg_orgm_ifmc = lancamento.SG_ORGM_IFMC_RECB
    AND lancamento.DT_RFRN_MVMN = vdataMovimentoAux
    AND remuneracao.DT_RFRN_MVMN = vdataMovimentoAux
    AND LANCAMENTO.SG_ORGM_IFMC_RECB = 'EMI'
    AND lancamento.cd_bndr = cripto.cd_bndr
    AND lancamento.dt_rfrn_mvmn = cripto.dt_rfrn_mvmn
    AND lancamento.cd_tipo_pltf_pgmn = cripto.cd_tipo_pltf_pgmn
    AND lancamento.cd_crde = cripto.cd_crde
    AND lancamento.nu_rmsa_crde = cripto.nu_rmsa_crde
    AND lancamento.cd_emsr = cripto.cd_emsr
    AND lancamento.cd_pcsr = cripto.cd_pcsr
    AND lancamento.nu_rmsa_emsr = cripto.nu_rmsa_emsr
    AND lancamento.nu_sqnl = cripto.nu_sqnl
    AND cripto.CD_TIPO_CNCT_CRTO = 1
    AND bin.CD_BNDR = lancamento.CD_BNDR
    AND bin.NU_BIN = cripto.NU_BIN_RECB
    AND bin.CD_EMSR = lancamento.CD_EMSR
    AND bin.CD_TIPO_PLTF_PGMN = lancamento.CD_TIPO_PLTF_PGMN
    AND lancamento.CD_TIPO_TRNS_BNDR_recb in ('10', '20')
  GROUP BY
    lancamento.cd_bndr,
    lancamento.cd_crde,
    lancamento.CD_TIPO_PLTF_PGMN,
    lancamento.CD_EMSR,
    lancamento.CD_PCSR,
    lancamento.cd_tipo_trns_bndr_recb,
    lancamento.CD_PRDT_BNDR_RECB,
    lancamento.cd_tipo_trns_bndr_recb,
    lancamento.cd_tipo_trns_bndr_recb,
    lancamento.SG_ORGM_IFMC_RECB,
    lancamento.DT_RFRN_MVMN,
    remuneracao.DT_VNCM_LQDC_EMSR,
    lancamento.nu_rmsa_crde,
    lancamento.nu_rmsa_emsr,
    lancamento.CD_MODA_RECB,
    operador.CD_TIPO_OPRD,
    lancamento.CD_TIPO_APRS_TRNS_RECB,
    bin.NU_BNCO_LQDN;
  END SEL_CGAGRDEMISSOR0612;
