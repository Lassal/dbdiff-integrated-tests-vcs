schema: CLC
name: P_ENVIO_EMISSOR
routineType: PROCEDURE
returnParamater: null
parameters:
- name: V_CD_BNDR
  ordinalPosition: 1
  dataType: NUMBER
  parameterMode: IN
- name: V_CD_CRDE
  ordinalPosition: 2
  dataType: NUMBER
  parameterMode: IN
- name: V_CD_TIPO_PLTF_PGMN
  ordinalPosition: 3
  dataType: VARCHAR2
  parameterMode: IN
- name: V_NU_RMSA_CRDE
  ordinalPosition: 4
  dataType: NUMBER
  parameterMode: IN
- name: V_COMMIT_INTERVAL
  ordinalPosition: 5
  dataType: NUMBER
  parameterMode: IN
- name: V_DATE_MOVIMENTO
  ordinalPosition: 6
  dataType: DATE
  parameterMode: IN
- name: V_RET
  ordinalPosition: 7
  dataType: NUMBER
  parameterMode: OUT
routineDefinition: |-
  PROCEDURE "P_ENVIO_EMISSOR" (
    V_CD_BNDR IN NUMBER,
    V_CD_CRDE IN NUMBER,
    V_CD_TIPO_PLTF_PGMN IN VARCHAR2,
    V_NU_RMSA_CRDE IN NUMBER,
    V_COMMIT_INTERVAL IN NUMBER,
    V_DATE_MOVIMENTO IN DATE,
    V_RET OUT NUMBER
  ) AS --CURSOR
  CURSOR C_CURSOR IS
  SELECT
    TE.CD_BNDR,
    TE.CD_TIPO_PLTF_PGMN,
    TE.CD_CRDE,
    TE.NU_RMSA_CRDE,
    TE.CD_EMSR,
    TE.NU_RMSA_EMSR,
    TE.CD_PCSR,
    TE.NU_SQNL,
    CRTO_FPAN.NU_CRTO_CRPT_PCSR_RECB,
    CRTO_DPAN.NU_IDTF_RQSE_RECB,
    CRTO_DPAN.CD_NIVL_SGRN_RECB,
    CRTO_FPAN.CD_IDTF_CHVE_CRTO,
    LRR.VL_ITCM_VNDA,
    LR.QT_DIA_LQDC_ENVO_EMSR,
    CRTO_DPAN.CD_TIPO_CNCT_CRTO AS CD_TIPO_CNCT_CRTO_DPAN,
    LR.DT_LQDC_BNDR_EMSR,
    CRTO_FPAN.NU_BIN_RECB,
    LR.DT_RFRN_MVMN,
    LISTAGG(TE.TX_RGST_LNCM_TRNS_ETNC, '') WITHIN GROUP (
      ORDER BY
        TE.NU_SQNL_RGST_TRNS_ETNC
    ) AS TX_RGST_LNCM_TRNS_ETNC
  FROM
    CLC.TBCLCR_TRNS_ETNC_LNCM_RECB TE
    INNER JOIN CLC.TBCLCR_LNCM_RECB LR ON TE.CD_BNDR = LR.CD_BNDR
    AND TE.DT_RFRN_MVMN = LR.DT_RFRN_MVMN
    AND TE.CD_TIPO_PLTF_PGMN = LR.CD_TIPO_PLTF_PGMN
    AND TE.CD_CRDE = LR.CD_CRDE
    AND TE.NU_RMSA_CRDE = LR.NU_RMSA_CRDE
    AND TE.CD_EMSR = LR.CD_EMSR
    AND TE.CD_PCSR = LR.CD_PCSR
    AND TE.NU_RMSA_EMSR = LR.NU_RMSA_EMSR
    AND TE.NU_SQNL = LR.NU_SQNL
    LEFT JOIN CLC.TBCLCR_LNCM_RECB_RMNR LRR ON LRR.CD_BNDR = LR.CD_BNDR
    AND LRR.CD_CRDE = LR.CD_CRDE
    AND LRR.CD_EMSR = LR.CD_EMSR
    AND LRR.NU_SQNL = LR.NU_SQNL
    AND LRR.CD_TIPO_PLTF_PGMN = LR.CD_TIPO_PLTF_PGMN
    AND LRR.DT_RFRN_MVMN = LR.DT_RFRN_MVMN
    AND LRR.NU_RMSA_CRDE = LR.NU_RMSA_CRDE
    AND LRR.CD_PCSR = LR.CD_PCSR
    AND LRR.NU_RMSA_EMSR = LR.NU_RMSA_EMSR
    AND LRR.CD_TIPO_TRNS_BNDR_RECB = LR.CD_TIPO_TRNS_BNDR_RECB
    AND LRR.NU_RFRN = NVL(LR.NU_RFRN, 0)
    LEFT JOIN CLC.TBCLCR_CRTO_CRPT_LNCM_RECB CRTO_DPAN ON CRTO_DPAN.CD_BNDR = LR.CD_BNDR
    AND CRTO_DPAN.CD_CRDE = LR.CD_CRDE
    AND CRTO_DPAN.CD_EMSR = LR.CD_EMSR
    AND CRTO_DPAN.CD_PCSR = LR.CD_PCSR
    AND CRTO_DPAN.CD_TIPO_PLTF_PGMN = LR.CD_TIPO_PLTF_PGMN
    AND CRTO_DPAN.DT_RFRN_MVMN = LR.DT_RFRN_MVMN
    AND CRTO_DPAN.NU_RMSA_CRDE = LR.NU_RMSA_CRDE
    AND CRTO_DPAN.NU_RMSA_EMSR = LR.NU_RMSA_EMSR
    AND CRTO_DPAN.NU_SQNL = LR.NU_SQNL
    AND CRTO_DPAN.CD_TIPO_CNCT_CRTO = 2
    INNER JOIN CLC.TBCLCR_CRTO_CRPT_LNCM_RECB CRTO_FPAN ON CRTO_FPAN.CD_BNDR = LR.CD_BNDR
    AND CRTO_FPAN.CD_CRDE = LR.CD_CRDE
    AND CRTO_FPAN.CD_EMSR = LR.CD_EMSR
    AND CRTO_FPAN.CD_PCSR = LR.CD_PCSR
    AND CRTO_FPAN.CD_TIPO_PLTF_PGMN = LR.CD_TIPO_PLTF_PGMN
    AND CRTO_FPAN.DT_RFRN_MVMN = LR.DT_RFRN_MVMN
    AND CRTO_FPAN.NU_RMSA_CRDE = LR.NU_RMSA_CRDE
    AND CRTO_FPAN.NU_RMSA_EMSR = LR.NU_RMSA_EMSR
    AND CRTO_FPAN.NU_SQNL = LR.NU_SQNL
    AND CRTO_FPAN.CD_TIPO_CNCT_CRTO = 1
  WHERE
    LR.CD_BNDR = V_CD_BNDR
    AND LR.CD_CRDE = V_CD_CRDE
    AND LR.NU_RMSA_CRDE = V_NU_RMSA_CRDE
    AND LR.CD_TIPO_PLTF_PGMN = V_CD_TIPO_PLTF_PGMN
    AND LR.SG_ORGM_IFMC_RECB = 'CRD'
    AND LR.DT_RFRN_MVMN = V_DATE_MOVIMENTO
    AND LR.CD_TIPO_TRNS_BNDR_RECB IN ('05', '06', '10', '20', '25', '26', '40')
  GROUP BY
    TE.CD_BNDR,
    TE.CD_TIPO_PLTF_PGMN,
    TE.CD_CRDE,
    TE.NU_RMSA_CRDE,
    TE.CD_EMSR,
    TE.NU_RMSA_EMSR,
    TE.CD_PCSR,
    TE.NU_SQNL,
    CRTO_FPAN.NU_CRTO_CRPT_PCSR_RECB,
    CRTO_DPAN.NU_IDTF_RQSE_RECB,
    CRTO_DPAN.CD_NIVL_SGRN_RECB,
    CRTO_FPAN.CD_IDTF_CHVE_CRTO,
    LRR.VL_ITCM_VNDA,
    LR.QT_DIA_LQDC_ENVO_EMSR,
    CRTO_DPAN.CD_TIPO_CNCT_CRTO,
    LR.DT_LQDC_BNDR_EMSR,
    CRTO_FPAN.NU_BIN_RECB,
    LR.DT_RFRN_MVMN;
  TYPE TYPE_CURSOR IS TABLE OF C_CURSOR % ROWTYPE INDEX BY BINARY_INTEGER;
  R_CURSOR TYPE_CURSOR;
  BEGIN
    V_RET: = 0;
  OPEN C_CURSOR;
  LOOP
    FETCH C_CURSOR BULK COLLECT INTO R_CURSOR
  LIMIT
    V_COMMIT_INTERVAL;
  EXIT
    WHEN R_CURSOR.COUNT = 0;
  FOR I IN 1 .. R_CURSOR.COUNT
  LOOP
  INSERT INTO
    CLC.TBCLCW_TRTM_MVMN_RECB_DIA (
      CD_BNDR,
      CD_TIPO_PLTF_PGMN,
      CD_CRDE,
      NU_RMSA_CRDE,
      CD_EMSR,
      NU_RMSA_EMSR,
      CD_PCSR,
      TX_RGST_LNCM_TRNS_ETNC,
      NU_SQNL,
      NU_CRTO_CRPT_PCSR_RECB,
      NU_IDTF_RQSE_RECB,
      CD_NIVL_SGRN_RECB,
      CD_IDTF_CHVE_CRTO,
      VL_ITCM_VNDA,
      QT_DIA_LQDC_ENVO_EMSR,
      CD_TIPO_CNCT_CRTO,
      DT_LQDC_BNDR_EMSR,
      NU_BIN_RECB,
      DT_RFRN_MVMN
    )
  VALUES
    (
      R_CURSOR(I) .CD_BNDR,
      R_CURSOR(I) .CD_TIPO_PLTF_PGMN,
      R_CURSOR(I) .CD_CRDE,
      R_CURSOR(I) .NU_RMSA_CRDE,
      R_CURSOR(I) .CD_EMSR,
      R_CURSOR(I) .NU_RMSA_EMSR,
      R_CURSOR(I) .CD_PCSR,
      R_CURSOR(I) .TX_RGST_LNCM_TRNS_ETNC,
      R_CURSOR(I) .NU_SQNL,
      R_CURSOR(I) .NU_CRTO_CRPT_PCSR_RECB,
      R_CURSOR(I) .NU_IDTF_RQSE_RECB,
      R_CURSOR(I) .CD_NIVL_SGRN_RECB,
      R_CURSOR(I) .CD_IDTF_CHVE_CRTO,
      R_CURSOR(I) .VL_ITCM_VNDA,
      R_CURSOR(I) .QT_DIA_LQDC_ENVO_EMSR,
      R_CURSOR(I) .CD_TIPO_CNCT_CRTO_DPAN,
      R_CURSOR(I) .DT_LQDC_BNDR_EMSR,
      R_CURSOR(I) .NU_BIN_RECB,
      R_CURSOR(I) .DT_RFRN_MVMN
    );
  V_RET: = V_RET + 1;
  END
  LOOP;
  COMMIT;
  END
  LOOP
    C_CURSOR;
  CLOSE C_CURSOR;
  COMMIT;
  END;
